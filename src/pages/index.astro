---
import Layout from "@layouts/Layout.astro";
import Nav from "@components/Nav.astro";
import Details from "@components/Details.astro";
import BackgroundPattern from "@assets/background.svg";

const frontmatter = {
  title: "Services Scroll Interaction | Home",
  description:
    "Welcome to Services Scroll Interaction! Explore our front-end and back-end services with a unique scroll-based interaction that highlights our offerings dynamically.",
};

const mainContent = [
  {
    topicPrefix: "Front",
    title: "Front End Services",
    items: [
      {
        title: "Creative development",
        description:
          "We create beautiful, functional, and engaging websites that captivate users and drive results. Our team of experts combines creativity with technical expertise to deliver exceptional web experiences.",
      },
      {
        title: "Animation",
        description:
          "Our animation services bring your website to life, adding dynamic elements that enhance user engagement. From subtle transitions to eye-catching effects, we create animations that complement your brand and captivate your audience.",
      },
      {
        title: "Landing pages",
        description:
          "We design and develop high-converting landing pages that drive traffic and generate leads. Our landing pages are optimized for performance, ensuring a seamless user experience that encourages conversions.",
      },
      {
        title: "Performance optimization",
        description:
          "We optimize your website for speed and performance, ensuring fast load times and smooth interactions. Our performance optimization services enhance user experience and improve search engine rankings.",
      },
      {
        title: "Accessibility",
        description:
          "We ensure your website is accessible to all users, including those with disabilities. Our accessibility services comply with WCAG standards, making your website inclusive and user-friendly for everyone.",
      },
      {
        title: "Responsive design",
        description:
          "We create responsive designs that adapt seamlessly to different devices and screen sizes. Our responsive design services ensure your website looks great and functions flawlessly on desktops, tablets, and smartphones.",
      },
      {
        title: "Web development",
        description:
          "We provide comprehensive web development services, from front-end to back-end. Our team builds robust, scalable, and secure websites that meet your business needs and exceed user expectations.",
      },
    ],
  },
  {
    topicPrefix: "Back",
    title: "Back End Services",
    items: [
      {
        title: "API development",
        description:
          "We develop robust APIs that enable seamless communication between your website and external services. Our API development services ensure your website can integrate with third-party applications and platforms.",
      },
      {
        title: "Database management",
        description:
          "We provide database management services to ensure your website's data is organized, secure, and easily accessible. Our team optimizes database performance and implements best practices for data integrity.",
      },
      {
        title: "Server-side scripting",
        description:
          "We create dynamic, server-side scripts that enhance your website's functionality. Our server-side scripting services enable complex interactions and data processing, delivering a rich user experience.",
      },
      {
        title: "Security",
        description:
          "We implement robust security measures to protect your website from threats and vulnerabilities. Our security services include regular audits, vulnerability assessments, and proactive monitoring.",
      },
      {
        title: "Content management systems (CMS)",
        description:
          "We develop and customize content management systems to empower you to manage your website's content easily. Our CMS solutions are user-friendly and scalable, allowing you to grow your online presence effortlessly.",
      },
      {
        title: "E-commerce solutions",
        description:
          "We build secure and scalable e-commerce solutions that drive sales and enhance customer experience. Our e-commerce services include payment gateway integration, product management, and order processing.",
      },
      {
        title: "Cloud services",
        description:
          "We offer cloud services to ensure your website is scalable, reliable, and cost-effective. Our cloud solutions include hosting, storage, and computing resources tailored to your business needs.",
      },
    ],
  },
  {
    topicPrefix: "Start-",
    title: "Start-to-End Services",
    items: [
      {
        title: "API development",
        description:
          "We develop robust APIs that enable seamless communication between your website and external services. Our API development services ensure your website can integrate with third-party applications and platforms.",
      },
      {
        title: "Database management",
        description:
          "We provide database management services to ensure your website's data is organized, secure, and easily accessible. Our team optimizes database performance and implements best practices for data integrity.",
      },
      {
        title: "Server-side scripting",
        description:
          "We create dynamic, server-side scripts that enhance your website's functionality. Our server-side scripting services enable complex interactions and data processing, delivering a rich user experience.",
      },
      {
        title: "Security",
        description:
          "We implement robust security measures to protect your website from threats and vulnerabilities. Our security services include regular audits, vulnerability assessments, and proactive monitoring.",
      },
      {
        title: "Content management systems (CMS)",
        description:
          "We develop and customize content management systems to empower you to manage your website's content easily. Our CMS solutions are user-friendly and scalable, allowing you to grow your online presence effortlessly.",
      },
      {
        title: "E-commerce solutions",
        description:
          "We build secure and scalable e-commerce solutions that drive sales and enhance customer experience. Our e-commerce services include payment gateway integration, product management, and order processing.",
      },
      {
        title: "Cloud services",
        description:
          "We offer cloud services to ensure your website is scalable, reliable, and cost-effective. Our cloud solutions include hosting, storage, and computing resources tailored to your business needs.",
      },
    ],
  },
];
---

<Layout title={frontmatter.title} description={frontmatter.description}>
  <!-- Background pattern is fixed and in the back -->
  <BackgroundPattern
    id="background-svg"
    class="background-svg fixed top-0 right-0 bottom-0 left-0 w-screen h-auto"
  />
  <Nav />
  <!-- Two columns: First one has title/pagination and is sticky -->
  <main
    id="main"
    class="grow container laptop:py-20 laptop:grid laptop:grid-cols-2 laptop:gap-10"
  >
    <!-- 145px is the distance from the top of the page to the sticky first column (nav height + section padding) -->
    <section
      class="z-10 bg-gray-200 laptop:bg-transparent pb-5 laptop:pb-0 border-b border-b-gray-300 laptop:border-none sticky top-0 h-max laptop:h-[calc(100vh_-_145px)] pt-[65px] -mt-[65px] laptop:pt-[145px] laptop:-mt-[145px] flex laptop:flex-col justify-between"
    >
      <h1
        class="font-extrabold uppercase text-5xl tablet:text-7xl laptop:text-8xl desktop:text-9xl laptop:leading-28 flex flex-col gap-4 w-3/4 laptop:w-auto"
        aria-label="Front End and Back End Services"
      >
        <!-- Will add "animate-swap" class dynamically based on intersection observer -->
        <div
          class="text-window relative overflow-hidden h-[60px] tablet:h-[120px] w-full"
        >
          {
            mainContent.map((content, index) => (
              <span
                id={`topic-display--${index}`}
                data-id={index}
                class={`absolute bottom-0 left-0 ${index === 0 ? "active-text" : "inactive-text"}`}
              >
                {[...content.topicPrefix].map(
                  (char: string, charIndex: number) => (
                    <span style={{ "--index": charIndex }}>{char}</span>
                  ),
                )}
              </span>
            ))
          }
        </div>
        End
      </h1>

      <div
        class="page-number-window relative overflow-hidden h-[60px] tablet:h-[120px] font-extrabold uppercase text-5xl tablet:text-7xl laptop:text-8xl desktop:text-9xl laptop:leading-28 w-1/4 laptop:w-auto"
      >
        {
          mainContent.map((content, index) => {
            const pageNum = (index + 1).toString().padStart(2, "0");
            return (
              <span
                id={`page-number--${index}`}
                data-id={index}
                class={`absolute bottom-0 right-0 laptop:left-0 ${index === 0 ? "active-text" : "inactive-text"}`}
              >
                {[...pageNum].map((char: string, charIndex: number) => (
                  <span style={{ "--index": charIndex }}>{char}</span>
                ))}
              </span>
            );
          })
        }
      </div>
    </section>

    <!-- Second column: Content for the page -->
    <section
      class="mt-10 laptop:mt-0 py-10 px-4 rounded-none tablet:p-10 tablet:rounded-3xl backdrop-blur-md bg-gray-300/25"
    >
      {
        mainContent.map((content, index) => (
          <>
            <h2
              id={`topic-header--${index}`}
              data-id={index}
              class={`text-lg ${index > 0 ? "pt-24 laptop:pt-40" : ""} pb-5 border-b-2 border-gray-300`}
            >
              {content.title}
            </h2>
            {content.items.map((item) => (
              <Details
                name={content.title}
                title={item.title}
                description={item.description}
              />
            ))}
          </>
        ))
      }
    </section>

    <span class="block col-span-2 pb-80"></span>
  </main>
</Layout>

<script>
  // On scroll, if the "#topic-header--<index>" element is in view, update the active page number and add the animate-swap class to "text-window"
  const topicHeaders = document.querySelectorAll("[id^='topic-header--']");
  const displayTexts = document.querySelectorAll("[id^='topic-display--']");
  const displayNumbers = document.querySelectorAll("[id^='page-number--']");
  const textWindow = document.querySelector(".text-window");
  const pageNumberWindow = document.querySelector(".page-number-window");

  let animationTimeout: ReturnType<typeof setTimeout> | null = null;
  let isAnimating = false;

  const handleIntersect = (entries: IntersectionObserverEntry[]) => {
    entries.forEach((entry: IntersectionObserverEntry) => {
      const activeDisplay = textWindow?.querySelector(".active-text");
      const activePageNumber = pageNumberWindow?.querySelector(".active-text");
      const activeIndex = Number(activeDisplay?.getAttribute("data-id"));

      if (entry.isIntersecting) {
        const intersectingElement = entry.target;
        const intersectingIndex = Number(
          intersectingElement.getAttribute("data-id"),
        );

        // If the current displayed index is the same as the one in view, do nothing
        if (activeIndex === intersectingIndex) {
          console.log("No change needed, same topic in view.");
          return;
        }

        // Cancel any pending animation
        if (animationTimeout) {
          clearTimeout(animationTimeout);
          animationTimeout = null;
        }

        // If already animating, immediately complete the current animation
        if (isAnimating) {
          textWindow?.classList.remove("animate-swap");
          pageNumberWindow?.classList.remove("animate-swap");

          // Clean up any pending activate classes
          displayTexts.forEach((text) => text.classList.remove("activate"));
          displayNumbers.forEach((num) => num.classList.remove("activate"));
        }

        // If the current displayed index is different from the one in view
        if (
          textWindow &&
          pageNumberWindow &&
          activeDisplay &&
          activePageNumber
        ) {
          isAnimating = true;

          // Add "animate-swap" class to textWindow and pageNumberWindow
          displayTexts[intersectingIndex].classList.add("activate");
          displayNumbers[intersectingIndex].classList.add("activate");
          textWindow.classList.add("animate-swap");
          pageNumberWindow.classList.add("animate-swap");

          // Once the animation is done, swap the old and new text
          animationTimeout = setTimeout(() => {
            activeDisplay.classList.replace("active-text", "inactive-text");
            activePageNumber.classList.replace("active-text", "inactive-text");

            displayTexts[intersectingIndex].classList.replace(
              "inactive-text",
              "active-text",
            );
            displayTexts[intersectingIndex].classList.remove("activate");
            displayNumbers[intersectingIndex].classList.replace(
              "inactive-text",
              "active-text",
            );
            displayNumbers[intersectingIndex].classList.remove("activate");

            // Remove the animate-swap class after the animation is done
            textWindow.classList.remove("animate-swap");
            pageNumberWindow.classList.remove("animate-swap");

            isAnimating = false;
            animationTimeout = null;
          }, 1000); // Match this duration with your CSS animation duration
        }
      }
    });
  };

  const createObserver = () => {
    let observer;

    let options = {
      root: null,
      rootMargin: "10% 0px -50% 0px",
      threshold: 1,
    };

    observer = new IntersectionObserver(handleIntersect, options);
    topicHeaders.forEach((header) => {
      observer.observe(header);
    });
  };

  createObserver();
</script>

<script>
  // On window blur, add "animation-play-state: paused" to the background SVG
  window.addEventListener("blur", () => {
    const backgroundSvg = document.getElementById("background-svg");
    if (backgroundSvg) {
      backgroundSvg.style.animationPlayState = "paused";
    }
  });

  // On window focus, remove "animation-play-state: paused" from the background SVG
  window.addEventListener("focus", () => {
    const backgroundSvg = document.getElementById("background-svg");
    if (backgroundSvg) {
      backgroundSvg.style.animationPlayState = "running";
    }
  });
</script>

<style>
  .active-text span,
  .inactive-text span {
    display: inline-block;
  }

  .active-text span {
    opacity: 1;
  }

  .inactive-text span {
    opacity: 0;
  }

  .animate-swap .active-text span {
    animation: slideOutUp 1s forwards;
    animation-delay: calc(0.05s * var(--index));
  }

  .animate-swap .inactive-text.activate span {
    animation: slideInUp 1s forwards;
    animation-delay: calc(0.05s * var(--index));
  }

  @keyframes slideOutUp {
    0% {
      transform: translateY(0);
      opacity: 1;
    }
    100% {
      transform: translateY(-100%);
      opacity: 0;
    }
  }

  @keyframes slideInUp {
    0% {
      transform: translateY(100%);
      opacity: 0;
    }
    100% {
      transform: translateY(0);
      opacity: 1;
    }
  }

  @media (prefers-reduced-motion) {
    .animate-swap .active-text span,
    .animate-swap .inactive-text.activate span {
      animation: none;
      animation-delay: 0;
    }
  }
</style>
